{% extends "base.html" %}

{% block head_extra %}
<style>
    /* Table styles matching department_config */
    .table-responsive {
        max-height: 75vh;
        border-bottom: 1px solid #e6e7e9;
    }

    th {
        white-space: nowrap;
        background-color: #f8fafc !important;
        position: sticky;
        top: 0;
        z-index: 10;
        box-shadow: 0 1px 0 #e6e7e9;
        font-weight: 600;
        color: #667085;
        font-size: 0.875rem;
        text-align: center;
        vertical-align: middle;
    }

    /* Column widths */
    th.w-number {
        width: 60px;
        min-width: 60px;
    }

    th.w-text-sm {
        min-width: 100px;
    }

    th.w-text-md {
        min-width: 150px;
    }

    /* Editable cell styles */
    .editable-cell {
        padding: 0 !important;
    }

    .editable-cell input {
        border: none;
        background: transparent;
        width: 100%;
        height: 100%;
        padding: 0.5rem 0.5rem;
        font-family: inherit;
        font-size: 14px;
        color: inherit;
        cursor: default;
        text-align: center;
    }

    .editable-cell input.text-start {
        text-align: left;
    }

    /* Edit mode styles */
    .editable-cell input:not([readonly]) {
        cursor: text;
        background-color: #fff;
        box-shadow: inset 0 0 0 1px #dce1e7;
    }

    .editable-cell input:not([readonly]):focus {
        outline: 2px solid #206bc4;
        z-index: 5;
        position: relative;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-xl">
    <!-- Header & Actions -->
    <div class="row g-2 align-items-center mb-3">
        <div class="col">
            <h2 class="page-title">正职推荐库</h2>
            <div class="text-muted mt-1">共 {{ data|length }} 人 <span id="status-badge"
                    class="badge bg-green-lt ms-2">查看模式</span></div>
        </div>
        <div class="col-auto ms-auto d-print-none">
            <div class="btn-list">
                <input type="file" id="excelFile" accept=".xls,.xlsx" style="display: none;" onchange="uploadFile()">
                <button class="btn btn-white" onclick="document.getElementById('excelFile').click()">
                    <i class="ti ti-upload me-2"></i>导入名单
                </button>
                <button class="btn btn-white" onclick="exportData()">
                    <i class="ti ti-download me-2"></i>导出
                </button>
                <div class="vr mx-2"></div>
                <button id="btn-edit" class="btn btn-primary" onclick="toggleEditMode(true)">
                    <i class="ti ti-pencil me-2"></i>开启编辑
                </button>
                <div id="action-group" style="display: none;">
                    <button class="btn btn-ghost-danger me-2" onclick="cancelEdit()">取消</button>
                    <button class="btn btn-primary" onclick="saveData()">
                        <i class="ti ti-device-floppy me-2"></i>保存修改
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="card">
        <div class="table-responsive">
            <table class="table table-vcenter table-bordered card-table table-striped table-hover" id="dataTable">
                <thead>
                    <tr>
                        <th class="w-number">排序号</th>
                        <th class="w-text-sm">姓名<span class="text-red">*</span></th>
                        <th class="w-number">性别</th>
                        <th class="w-text-sm">出生年月</th>
                        <th class="w-text-md">部门名称</th>
                        <th class="w-text-sm">部门代码</th>
                        <th class="w-text-sm">岗位层级</th>
                        <th class="w-text-sm">文化程度</th>
                        <th class="w-text-sm">现职级时间</th>
                        <th class="w-text-md">现职务</th>
                        <th class="w-1 text-center" style="min-width: 50px;">操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in data %}
                    <tr>
                        <td class="editable-cell"><input type="number" name="sort_no" value="{{ item.sort_no or '' }}"
                                readonly></td>
                        <td class="editable-cell"><input type="text" name="name" value="{{ item.name or '' }}"
                                class="text-start" required readonly></td>
                        <td class="editable-cell"><input type="text" name="gender" value="{{ item.gender or '' }}"
                                readonly></td>
                        <td class="editable-cell"><input type="text" name="birth_date"
                                value="{{ item.birth_date or '' }}" placeholder="YYYY/MM" readonly></td>
                        <td class="editable-cell"><input type="text" name="dept_name" value="{{ item.dept_name or '' }}"
                                class="text-start" readonly></td>
                        <td class="editable-cell"><input type="text" name="dept_code" value="{{ item.dept_code or '' }}"
                                readonly></td>
                        <td class="editable-cell"><input type="text" name="rank_level"
                                value="{{ item.rank_level or '' }}" readonly></td>
                        <td class="editable-cell"><input type="text" name="education" value="{{ item.education or '' }}"
                                readonly></td>
                        <td class="editable-cell"><input type="text" name="rank_time" value="{{ item.rank_time or '' }}"
                                placeholder="YYYY/MM" readonly></td>
                        <td class="editable-cell"><input type="text" name="current_position"
                                value="{{ item.current_position or '' }}" class="text-start" readonly></td>
                        <td class="text-center">
                            <a href="#" class="link-secondary disabled delete-btn" onclick="deleteRow(this)"><i
                                    class="ti ti-trash"></i></a>
                        </td>
                    </tr>
                    {% else %}
                    <tr id="empty-row">
                        <td colspan="11" class="text-center text-muted py-5">暂无数据，请导入Excel文件</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="card-footer d-flex align-items-center">
            <button id="btn-add-row" class="btn btn-ghost-primary disabled" onclick="addRow()" disabled>
                <i class="ti ti-plus me-1"></i>手动新增
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block script_extra %}
<script>
    function toggleEditMode(isEdit) {
        document.querySelectorAll('#dataTable input').forEach(el => el.readOnly = !isEdit);
        document.querySelectorAll('.delete-btn').forEach(el => {
            el.classList.toggle('disabled', !isEdit);
            el.classList.toggle('link-secondary', !isEdit);
            el.classList.toggle('link-danger', isEdit);
        });
        const btnAdd = document.getElementById('btn-add-row');
        btnAdd.classList.toggle('disabled', !isEdit);
        btnAdd.disabled = !isEdit;
        document.getElementById('btn-edit').style.display = isEdit ? 'none' : 'inline-block';
        document.getElementById('action-group').style.display = isEdit ? 'inline-block' : 'none';
        const badge = document.getElementById('status-badge');
        badge.className = isEdit ? 'badge bg-orange-lt ms-2' : 'badge bg-green-lt ms-2';
        badge.innerText = isEdit ? '编辑中...' : '查看模式';
    }

    function cancelEdit() {
        if (confirm('取消将丢失未保存的修改，确定吗？')) location.reload();
    }

    function exportData() {
        window.location.href = "/api/recommend-principal/export";
    }

    function deleteRow(btn) {
        if (!btn.classList.contains('disabled') && confirm('确定移除该行？(需保存后生效)')) {
            btn.closest('tr').remove();
        }
    }

    async function uploadFile() {
        const file = document.getElementById('excelFile').files[0];
        if (!file || !confirm('警告：导入将覆盖当前所有数据，确定继续吗？')) return;
        const fd = new FormData();
        fd.append('file', file);
        document.body.style.cursor = 'wait';
        try {
            const res = await (await fetch('/api/recommend-principal/upload', { method: 'POST', body: fd })).json();
            alert(res.msg);
            if (res.success) location.reload();
        } catch (e) {
            alert('上传失败: ' + e);
        } finally {
            document.body.style.cursor = 'default';
            document.getElementById('excelFile').value = '';
        }
    }

    async function saveData() {
        const rows = document.querySelectorAll('#dataTable tbody tr');
        const data = [];
        if (rows.length === 1 && rows[0].id === 'empty-row') return alert('无数据可保存');
        let err = false;
        rows.forEach(row => {
            if (row.querySelectorAll('input').length === 0) return;
            const obj = {};
            row.querySelectorAll('input').forEach(inp => {
                if (inp.name === 'name' && !inp.value.trim()) {
                    inp.closest('td').style.boxShadow = 'inset 0 0 0 2px red';
                    err = true;
                } else {
                    inp.closest('td').style.boxShadow = 'none';
                }
                obj[inp.name] = inp.value;
            });
            if (obj.name) data.push(obj);
        });
        if (err) return alert('请检查必填项(姓名)');
        document.body.style.cursor = 'wait';
        try {
            const res = await (await fetch('/api/recommend-principal/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data })
            })).json();
            alert(res.msg);
            if (res.success) location.reload();
        } catch (e) {
            alert('保存失败: ' + e);
        } finally {
            document.body.style.cursor = 'default';
        }
    }

    function addRow() {
        document.getElementById('empty-row')?.remove();
        const html = `<tr>
            <td class="editable-cell"><input type="number" name="sort_no"></td>
            <td class="editable-cell"><input type="text" name="name" class="text-start" required></td>
            <td class="editable-cell"><input type="text" name="gender"></td>
            <td class="editable-cell"><input type="text" name="birth_date" placeholder="YYYY/MM"></td>
            <td class="editable-cell"><input type="text" name="dept_name" class="text-start"></td>
            <td class="editable-cell"><input type="text" name="dept_code"></td>
            <td class="editable-cell"><input type="text" name="rank_level"></td>
            <td class="editable-cell"><input type="text" name="education"></td>
            <td class="editable-cell"><input type="text" name="rank_time" placeholder="YYYY/MM"></td>
            <td class="editable-cell"><input type="text" name="current_position" class="text-start"></td>
            <td class="text-center"><a href="#" class="link-danger delete-btn" onclick="deleteRow(this)"><i class="ti ti-trash"></i></a></td>
        </tr>`;
        document.querySelector('#dataTable tbody').insertAdjacentHTML('beforeend', html);
    }
</script>
{% endblock %}