{% extends "base_assessment.html" %}

{% block content %}
<div class="container-xl">
    <!-- Page Header -->
    <div class="row g-2 align-items-center mb-3">
        <div class="col">
            <h2 class="page-title">{{ page_title }}</h2>
            <div class="text-muted mt-1">
                请对下列新提拔任用干部进行评价。
            </div>
        </div>
        <div class="col-auto ms-auto">
            <div class="col-auto ms-auto">
                <a href="{{ url_for('assessment_overview') }}" class="btn btn-secondary me-2">
                    <i class="ti ti-arrow-left me-2"></i>返回概览
                </a>
                <button class="btn btn-primary" onclick="submitData()">
                    <i class="ti ti-device-floppy me-2"></i>保存
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Bar -->
    <div class="card mb-3">
        <div class="card-body py-2">
            <div class="row text-center">
                <div class="col-3 border-end">
                    <h4 class="m-0">认同</h4>
                    <div class="text-primary h2 m-0" id="count-agree">0</div>
                </div>
                <div class="col-3 border-end">
                    <h4 class="m-0">基本认同</h4>
                    <div class="text-primary h2 m-0" id="count-basic">0</div>
                </div>
                <div class="col-3 border-end">
                    <h4 class="m-0">不认同</h4>
                    <div class="text-primary h2 m-0" id="count-disagree">0</div>
                </div>
                <div class="col-3">
                    <h4 class="m-0">不了解</h4>
                    <div class="text-primary h2 m-0" id="count-unknown">0</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="table-responsive">
            <table class="table table-vcenter card-table table-bordered">
                <thead>
                    <tr>
                        <th class="w-1">序号</th>
                        <th>姓名</th>
                        <th>现职级时间</th>
                        <th>现任职务</th>
                        <th>任职时间</th>
                        <th>原任职务</th>
                        <th>提拔方式</th>
                        <th style="min-width: 350px;">对提拔任用基层领导人员的看法</th>
                    </tr>
                </thead>
                <tbody>
                    {% for c in candidates %}
                    <tr data-id="{{ c.id }}">
                        <td>{{ loop.index }}</td>
                        <td>{{ c.name }}</td>
                        <!-- Assuming rank_time is '现职级时间' and tenure_time is '任职时间' based on column names -->
                        <td>{{ c.rank_time if c.rank_time else '-' }}</td>
                        <td>{{ c.position }}</td>
                        <td>{{ c.tenure_time if c.tenure_time else '-' }}</td>
                        <td>{{ c.original_position if c.original_position else '-' }}</td>
                        <td>{{ c.promotion_method if c.promotion_method else '-' }}</td>
                        <td>
                            <div class="form-selectgroup">
                                {% set saved_val = existing_data.get(c.id|string) %}

                                <label class="form-selectgroup-item">
                                    <input type="radio" name="opt_{{ c.id }}" value="agree"
                                        class="form-selectgroup-input eval-radio" onchange="updateStats()" {% if
                                        saved_val=='agree' %}checked{% endif %}>
                                    <span class="form-selectgroup-label">认同</span>
                                </label>
                                <label class="form-selectgroup-item">
                                    <input type="radio" name="opt_{{ c.id }}" value="basic_agree"
                                        class="form-selectgroup-input eval-radio" onchange="updateStats()" {% if
                                        saved_val=='basic_agree' %}checked{% endif %}>
                                    <span class="form-selectgroup-label">基本认同</span>
                                </label>
                                <label class="form-selectgroup-item">
                                    <input type="radio" name="opt_{{ c.id }}" value="disagree"
                                        class="form-selectgroup-input eval-radio" onchange="updateStats()" {% if
                                        saved_val=='disagree' %}checked{% endif %}>
                                    <span class="form-selectgroup-label">不认同</span>
                                </label>
                                <label class="form-selectgroup-item">
                                    <input type="radio" name="opt_{{ c.id }}" value="unknown"
                                        class="form-selectgroup-input eval-radio" onchange="updateStats()" {% if
                                        saved_val=='unknown' %}checked{% endif %}>
                                    <span class="form-selectgroup-label">不了解</span>
                                </label>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block script_extra %}
<script>
    function updateStats() {
        const counts = {
            agree: 0,
            basic_agree: 0,
            disagree: 0,
            unknown: 0
        };

        const radios = document.querySelectorAll('.eval-radio:checked');
        radios.forEach(r => {
            if (counts.hasOwnProperty(r.value)) {
                counts[r.value]++;
            }
        });

        document.getElementById('count-agree').innerText = counts.agree;
        document.getElementById('count-basic').innerText = counts.basic_agree;
        document.getElementById('count-disagree').innerText = counts.disagree;
        document.getElementById('count-unknown').innerText = counts.unknown;
    }

    // Init stats on load
    document.addEventListener('DOMContentLoaded', updateStats);

    async function submitData() {
        const selections = {};
        const rows = document.querySelectorAll('tbody tr');

        rows.forEach(tr => {
            const id = tr.getAttribute('data-id');
            const checked = tr.querySelector('input[type="radio"]:checked');
            if (checked) {
                selections[id] = checked.value;
            }
        });

        // Validation: Optional? User didn't specify strict requiredness.
        // But usually "All Checked" is better. Let's warn if incomplete.
        const total = {{ candidates| length
    }};
    const selectedCount = Object.keys(selections).length;

    if (selectedCount < total) {
        alert(`您还有 ${total - selectedCount} 人未评价，请完成所有评价后再提交！`);
        return;
    }

    if (!confirm('确认保存吗？')) return;

    try {
        const res = await fetch('/api/assessment/new-promotion/submit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ selections: selections })
        });

        const data = await res.json();
        if (data.success) {
            alert('保存成功！');
            window.location.reload(); // Refresh to ensure saved state is reloaded
        } else {
            alert('提交失败：' + data.msg);
        }
    } catch (err) {
        alert('网络错误：' + err);
    }
    }
</script>
{% endblock %}