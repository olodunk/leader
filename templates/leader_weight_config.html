{% extends "base.html" %}

{% block head_extra %}
<style>
    .table-responsive {
        max-height: 75vh;
        border-bottom: 1px solid #e6e7e9;
    }

    th {
        white-space: nowrap;
        background-color: #f8fafc !important;
        position: sticky;
        top: 0;
        z-index: 10;
        box-shadow: 0 1px 0 #e6e7e9;
        text-align: center;
    }

    td input {
        border: none;
        background: transparent;
        width: 70px;
        padding: 4px;
        text-align: center;
    }

    td input:not([readonly]) {
        background-color: #fff;
        box-shadow: inset 0 0 0 1px #dce1e7;
    }

    td input:focus {
        outline: none;
        box-shadow: inset 0 0 0 2px #206bc4;
    }

    .leader-col {
        min-width: 80px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header & Actions -->
    <div class="row g-2 align-items-center mb-3">
        <div class="col">
            <h2 class="page-title">院领导权重配置</h2>
            <div class="text-muted mt-1">配置各部门 6 位院领导的评分权重</div>
        </div>

        <div class="col-auto ms-auto d-print-none">
            <button id="btn-edit" class="btn btn-primary" onclick="toggleEditMode(true)">
                <i class="ti ti-pencil me-2"></i>编辑
            </button>
            <div id="action-group" style="display: none;">
                <button class="btn btn-ghost-danger me-2" onclick="cancelEdit()">取消</button>
                <button class="btn btn-primary" onclick="saveData()">保存</button>
            </div>
        </div>
    </div>

    <!-- Table -->
    <div class="card">
        <div class="table-responsive">
            <table class="table table-vcenter table-bordered card-table table-striped" id="dataTable">
                <thead>
                    <tr>
                        <th class="text-center" style="width:50px;">序号</th>
                        <th style="min-width:200px;">部门名称</th>
                        <th class="leader-col">总比例(%)</th>
                        <th class="leader-col">杨卫胜(%)</th>
                        <th class="leader-col">王凌(%)</th>
                        <th class="leader-col">许青春(%)</th>
                        <th class="leader-col">赵彤(%)</th>
                        <th class="leader-col">葛少辉(%)</th>
                        <th class="leader-col">刘超伟(%)</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Loaded via JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block script_extra %}
<script>
    let originalData = [];

    document.addEventListener('DOMContentLoaded', () => loadData());

    async function loadData() {
        try {
            const res = await (await fetch('/api/leader-weight-config/list')).json();
            if (res.success) {
                originalData = JSON.parse(JSON.stringify(res.data));
                renderTable(res.data);
            } else {
                alert('加载失败: ' + res.msg);
            }
        } catch (e) {
            alert('加载失败: ' + e);
        }
    }

    function renderTable(data) {
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = data.map((item, idx) => `
            <tr data-code="${item.dept_code}">
                <td class="text-center">${idx + 1}</td>
                <td><strong>${item.dept_name || item.dept_code}</strong></td>
                <td><input type="number" step="1" name="total_weight" value="${item.total_weight || 50}" readonly></td>
                <td><input type="number" step="1" name="w_yang_weisheng" value="${item.w_yang_weisheng || 0}" readonly></td>
                <td><input type="number" step="1" name="w_wang_ling" value="${item.w_wang_ling || 0}" readonly></td>
                <td><input type="number" step="1" name="w_xu_qingchun" value="${item.w_xu_qingchun || 0}" readonly></td>
                <td><input type="number" step="1" name="w_zhao_tong" value="${item.w_zhao_tong || 0}" readonly></td>
                <td><input type="number" step="1" name="w_ge_shaohui" value="${item.w_ge_shaohui || 0}" readonly></td>
                <td><input type="number" step="1" name="w_liu_chaowei" value="${item.w_liu_chaowei || 0}" readonly></td>
            </tr>
        `).join('');
    }

    function toggleEditMode(edit) {
        document.querySelectorAll('#dataTable input').forEach(el => el.readOnly = !edit);
        document.getElementById('btn-edit').style.display = edit ? 'none' : 'inline-block';
        document.getElementById('action-group').style.display = edit ? 'inline-block' : 'none';
    }

    function cancelEdit() {
        if (confirm('取消将丢失未保存的修改，确定吗？')) {
            renderTable(originalData);
            toggleEditMode(false);
        }
    }

    async function saveData() {
        const rows = document.querySelectorAll('#dataTable tbody tr');
        const updates = [];

        rows.forEach(tr => {
            const code = tr.getAttribute('data-code');
            const name = tr.querySelector('td:nth-child(2) strong')?.innerText;
            updates.push({
                dept_code: code,
                dept_name: name,
                total_weight: parseFloat(tr.querySelector('input[name="total_weight"]').value) || 0,
                w_yang_weisheng: parseFloat(tr.querySelector('input[name="w_yang_weisheng"]').value) || 0,
                w_wang_ling: parseFloat(tr.querySelector('input[name="w_wang_ling"]').value) || 0,
                w_xu_qingchun: parseFloat(tr.querySelector('input[name="w_xu_qingchun"]').value) || 0,
                w_zhao_tong: parseFloat(tr.querySelector('input[name="w_zhao_tong"]').value) || 0,
                w_ge_shaohui: parseFloat(tr.querySelector('input[name="w_ge_shaohui"]').value) || 0,
                w_liu_chaowei: parseFloat(tr.querySelector('input[name="w_liu_chaowei"]').value) || 0
            });
        });

        try {
            const res = await (await fetch('/api/leader-weight-config/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: updates })
            })).json();

            alert(res.msg);
            if (res.success) {
                toggleEditMode(false);
                loadData();
            }
        } catch (e) {
            alert('保存失败: ' + e);
        }
    }
</script>
{% endblock %}
