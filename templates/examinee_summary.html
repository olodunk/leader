{% extends "base.html" %}

{% block head_extra %}
<style>
    .table-responsive {
        max-height: 70vh;
        border-bottom: 1px solid #e6e7e9;
    }

    th {
        white-space: nowrap;
        background-color: #f8fafc !important;
        position: sticky;
        top: 0;
        z-index: 10;
        box-shadow: 0 1px 0 #e6e7e9;
        font-size: 11px;
        padding: 4px 6px;
    }

    th.w-name {
        min-width: 70px;
    }

    th.w-dept {
        min-width: 100px;
    }

    .editable-cell input {
        border: none;
        background: transparent;
        width: 55px;
        padding: 2px;
        text-align: center;
        font-size: 11px;
    }

    .editable-cell input:not([readonly]) {
        background-color: #fff;
        box-shadow: inset 0 0 0 1px #dce1e7;
    }

    .editable-cell input:focus {
        outline: none;
        box-shadow: inset 0 0 0 2px #206bc4;
    }

    td {
        font-size: 11px;
        text-align: center;
        padding: 2px 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header & Actions -->
    <div class="row g-2 align-items-center mb-3">
        <div class="col">
            <h2 class="page-title">被考核人汇总得分</h2>
            <div class="text-muted mt-1">共 <span id="total-count">0</span> 条记录</div>
        </div>

        <div class="col-auto ms-auto d-print-none d-flex align-items-center gap-2">
            <button class="btn btn-primary" onclick="calculateScores()">
                <i class="ti ti-calculator me-2"></i>一键计算
            </button>
            <button class="btn btn-ghost-danger" onclick="clearScores()">
                <i class="ti ti-trash me-2"></i>一键清空
            </button>

            <div class="vr mx-1"></div>

            <button id="btn-edit" class="btn btn-primary" onclick="toggleEditMode(true)">
                <i class="ti ti-pencil me-2"></i>编辑
            </button>
            <div id="action-group" style="display: none;">
                <button class="btn btn-ghost-danger me-2" onclick="cancelEdit()">取消</button>
                <button class="btn btn-primary" onclick="saveData()">保存</button>
            </div>

            <button class="btn btn-white" onclick="exportData()">
                <i class="ti ti-download me-2"></i>导出Excel
            </button>
        </div>
    </div>

    <!-- Table -->
    <div class="card">
        <div class="table-responsive">
            <table class="table table-vcenter table-bordered card-table table-striped" id="dataTable">
                <thead>
                    <tr>
                        <th class="w-name">姓名</th>
                        <th class="w-dept">部门名称</th>
                        <th>院领导评分</th>
                        <th>职能部门正职评分</th>
                        <th>职能部门副职评分</th>
                        <th>职能部门员工评分</th>
                        <th>职能部门ABC票加权评分</th>
                        <th>职能部门BC票加权评分</th>
                        <th>研究所正职评分</th>
                        <th>研究所副职评分</th>
                        <th>研究所其他员工评分</th>
                        <th>研究所ABC票加权评分</th>
                        <th>研究所BC票加权评分</th>
                        <th>中心及昆冈正职评分</th>
                        <th>中心及昆冈副职评分</th>
                        <th>中心及昆冈（含分公司）加权</th>
                        <th>基层领导评分（两中心及昆冈）</th>
                        <th>中心及昆冈其他员工评分</th>
                        <th>昆冈正职评分</th>
                        <th>昆冈副职评分</th>
                        <th>昆冈分公司正职评分</th>
                        <th>昆冈分公司副职评分</th>
                        <th>昆冈分公司加权</th>
                        <th>总分</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <tr>
                        <td colspan="24" class="text-center py-5 text-muted">点击"一键计算"生成数据</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Enhanced Pagination -->
    <div class="card-footer d-flex justify-content-between align-items-center bg-white border-top">
        <div class="d-flex align-items-center gap-2">
            <span class="text-muted small">每页</span>
            <select class="form-select form-select-sm" style="width: 70px;" id="limit-select" onchange="loadData(1)">
                <option value="30" selected>30</option>
                <option value="50">50</option>
                <option value="100">100</option>
            </select>
        </div>

        <div class="d-flex align-items-center gap-3">
            <ul class="pagination m-0" id="pagination"></ul>
            <div class="input-group input-group-sm" style="width: 120px;">
                <input type="number" class="form-control" id="page-jump-input" placeholder="页码" min="1">
                <button class="btn btn-outline-secondary" type="button" onclick="jumpToPage()">Go</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script_extra %}
<script>
    let originalData = [];

    // 所有分数字段（按表头顺序，共21个分数列）
    const scoreFields = [
        'score_college_leader',
        'score_func_principal', 'score_func_deputy', 'score_func_employee',
        'score_func_abc_weighted', 'score_func_bc_weighted',
        'score_inst_principal', 'score_inst_deputy', 'score_inst_employee',
        'score_inst_abc_weighted', 'score_inst_bc_weighted',
        'score_center_principal', 'score_center_deputy', 'score_center_kungang',
        'score_center_grassroot', 'score_center_employee',
        'score_kungang_principal', 'score_kungang_deputy',
        'score_branch_principal', 'score_branch_deputy', 'score_branch_weighted',
        'total_score'
    ];

    let currentPage = 1;
    let totalPages = 1;

    document.addEventListener('DOMContentLoaded', () => loadData(1));

    async function loadData(page = 1) {
        if (page < 1) page = 1;
        currentPage = page;
        const limit = document.getElementById('limit-select').value;
        const qs = new URLSearchParams({ page, limit }).toString();

        try {
            const res = await (await fetch(`/api/examinee-summary/list?${qs}`)).json();
            if (res.success) {
                renderTable(res.data);
                totalPages = Math.ceil(res.count / limit);
                document.getElementById('total-count').innerText = res.count;
                document.getElementById('page-jump-input').max = totalPages;
                renderPagination(totalPages, currentPage);
            }
        } catch (e) {
            console.error('加载失败:', e);
        }
    }

    function renderPagination(tm, cm) {
        const ul = document.getElementById('pagination');
        ul.innerHTML = '';
        if (tm <= 1) return;

        // First
        ul.innerHTML += `<li class="page-item ${cm == 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadData(1); return false;">&laquo;</a>
        </li>`;

        // Prev
        ul.innerHTML += `<li class="page-item ${cm == 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadData(${cm - 1}); return false;">&lsaquo;</a>
        </li>`;

        let start = Math.max(1, cm - 2);
        let end = Math.min(tm, cm + 2);

        if (start > 1) ul.innerHTML += `<li class="page-item disabled"><a class="page-link">...</a></li>`;
        for (let i = start; i <= end; i++) {
            ul.innerHTML += `<li class="page-item ${cm == i ? 'active' : ''}">
                <a class="page-link" href="#" onclick="loadData(${i}); return false;">${i}</a>
            </li>`;
        }
        if (end < tm) ul.innerHTML += `<li class="page-item disabled"><a class="page-link">...</a></li>`;

        // Next
        ul.innerHTML += `<li class="page-item ${cm == tm ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadData(${cm + 1}); return false;">&rsaquo;</a>
        </li>`;

        // Last
        ul.innerHTML += `<li class="page-item ${cm == tm ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadData(${tm}); return false;">&raquo;</a>
        </li>`;
    }

    function jumpToPage() {
        const val = parseInt(document.getElementById('page-jump-input').value);
        if (val && val >= 1 && val <= totalPages) {
            loadData(val);
        } else {
            alert(`请输入有效页码 (1-${totalPages})`);
        }
    }

    function renderTable(data) {
        const tbody = document.getElementById('table-body');

        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="23" class="text-center py-5 text-muted">暂无数据，请点击"一键计算"生成</td></tr>';
            return;
        }

        tbody.innerHTML = data.map(row => {
            let html = `<tr data-id="${row.id}">`;
            html += `<td><strong>${row.name || ''}</strong></td>`;
            html += `<td>${row.dept_name || ''}</td>`;

            // 所有分数字段
            scoreFields.forEach(field => {
                const val = row[field] || 0;
                const isTotal = field === 'total_score';
                if (isTotal) {
                    html += `<td><strong>${val > 0 ? val.toFixed(2) : ''}</strong></td>`;
                } else {
                    html += `<td class="editable-cell"><input type="number" step="0.01" name="${field}" value="${val > 0 ? val.toFixed(2) : ''}" readonly></td>`;
                }
            });

            html += '</tr>';
            return html;
        }).join('');
    }

    function toggleEditMode(edit) {
        document.querySelectorAll('#dataTable .editable-cell input').forEach(el => el.readOnly = !edit);
        document.getElementById('btn-edit').style.display = edit ? 'none' : 'inline-block';
        document.getElementById('action-group').style.display = edit ? 'inline-block' : 'none';
    }

    function cancelEdit() {
        if (confirm('取消将丢失未保存的修改，确定吗？')) {
            renderTable(originalData);
            toggleEditMode(false);
        }
    }

    async function calculateScores() {
        if (!confirm('确定开始一键计算汇总得分吗？')) return;
        document.body.style.cursor = 'wait';
        try {
            const res = await (await fetch('/api/examinee-summary/calculate', { method: 'POST' })).json();
            alert(res.msg);
            if (res.success) loadData();
        } catch (e) {
            alert('计算失败: ' + e);
        } finally {
            document.body.style.cursor = 'default';
        }
    }

    async function clearScores() {
        if (!confirm('确定清空所有汇总数据吗？此操作无法撤销。')) return;
        try {
            const res = await (await fetch('/api/examinee-summary/clear', { method: 'POST' })).json();
            alert(res.msg);
            if (res.success) loadData();
        } catch (e) {
            alert('清空失败: ' + e);
        }
    }

    async function saveData() {
        const rows = document.querySelectorAll('#dataTable tbody tr[data-id]');
        const updates = [];

        rows.forEach(tr => {
            const id = tr.dataset.id;
            const item = { id: parseInt(id) };

            tr.querySelectorAll('.editable-cell input').forEach(input => {
                const val = input.value.trim();
                item[input.name] = val ? parseFloat(val) : 0;
            });

            updates.push(item);
        });

        try {
            const res = await (await fetch('/api/examinee-summary/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: updates })
            })).json();

            alert(res.msg);
            if (res.success) {
                toggleEditMode(false);
                loadData();
            }
        } catch (e) {
            alert('保存失败: ' + e);
        }
    }

    function exportData() {
        window.location.href = '/api/examinee-summary/export';
    }
</script>
{% endblock %}