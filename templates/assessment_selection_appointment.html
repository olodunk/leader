{% extends "base_assessment.html" %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row g-2 align-items-center mb-3">
        <div class="col">
            <h2 class="page-title">{{ page_title }}</h2>
            <div class="text-muted mt-1">
                请对本单位选人用人工作及“一报告两评议”工作情况进行评价。
            </div>
        </div>
        <div class="col-auto ms-auto">
            <div class="col-auto ms-auto">
                <a href="{{ url_for('assessment_overview') }}" class="btn btn-secondary me-2">
                    <i class="ti ti-arrow-left me-2"></i>返回概览
                </a>
                <button class="btn btn-primary" onclick="submitData()">
                    <i class="ti ti-device-floppy me-2"></i>保存
                </button>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body">

            <!-- Q1 -->
            <div class="mb-4">
                <label class="form-label required">1、对本单位选人用人工作的总体评价</label>
                <div class="form-selectgroup">
                    {% for opt in ['好', '较好', '一般', '差'] %}
                    <label class="form-selectgroup-item">
                        <input type="radio" name="q1" value="{{ opt }}" class="form-selectgroup-input" {% if data and
                            data.q1_overall==opt %}checked{% endif %}>
                        <span class="form-selectgroup-label">{{ opt }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <!-- Q2 -->
            <div class="mb-4">
                <label class="form-label required">2、对本单位加强干部全方位管理和经常性监督情况的评价</label>
                <div class="form-selectgroup">
                    {% for opt in ['好', '较好', '一般', '差'] %}
                    <label class="form-selectgroup-item">
                        <input type="radio" name="q2" value="{{ opt }}" class="form-selectgroup-input" {% if data and
                            data.q2_supervision==opt %}checked{% endif %}>
                        <span class="form-selectgroup-label">{{ opt }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <!-- Q3 -->
            <div class="mb-4">
                <label class="form-label required">3、对上一年度评议反映问题整改情况的评价</label>
                <div class="form-selectgroup">
                    {% for opt in ['好', '较好', '一般', '差'] %}
                    <label class="form-selectgroup-item">
                        <input type="radio" name="q3" value="{{ opt }}" class="form-selectgroup-input" {% if data and
                            data.q3_rectification==opt %}checked{% endif %}>
                        <span class="form-selectgroup-label">{{ opt }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <div class="hr-text">问题与建议</div>

            <!-- Q4 -->
            <div class="mb-4">
                <label class="form-label">4、您认为本单位选人用人工作存在的主要问题是什么？（可多选，如认为无问题也可不选）</label>
                <div class="vstack gap-2">
                    {% set problems = [
                    "(1) 聚焦落实党中央要求和本单位职责使命加强领导班子和干部队伍建设不够",
                    "(2) 干部队伍建设统筹谋划不够、干部队伍结构不优",
                    "(3) 干部队伍能力素质不适应工作要求",
                    "(4) 干部队伍精神状态不佳或斗争精神不足",
                    "(5) 选人用人突出政治标准不够，严把政治关、廉洁关不到位",
                    "(6) 选人用人注重工作实绩、群众公认不够",
                    "(7) 激励担当作为有差距，推进领导干部能上能下不力",
                    "(8) 选人用人落实民主集中制不到位，存在“个人说了算”",
                    "(9) 坚持五湖四海、任人唯贤不够，存在任人唯亲、搞小圈子等不正之风",
                    "(10) 执行干部选拔任用政策和程序不规范",
                    "(11) 对“一把手”、关键岗位等管理监督不严，存在薄弱环节",
                    "(12) 党委巡察选人用人专项检查反馈问题整改落实不到位"
                    ] %}

                    {% set current_probs = data.q4_problems if data and data.q4_problems else '' %}

                    {% for p in problems %}
                    <label class="form-check">
                        <input class="form-check-input q4-check" type="checkbox" value="{{ loop.index }}" {% if
                            loop.index|string in current_probs.split(',') %}checked{% endif %}>
                        <span class="form-check-label">{{ p }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <!-- Q5 -->
            <div class="mb-4">
                <label class="form-label">5、您对加强和改进本单位选人用人工作有何意见建议？</label>
                <textarea class="form-control" rows="3"
                    id="q5">{{ data.q5_suggestions_employment if data else '' }}</textarea>
            </div>

            <!-- Q6 -->
            <div class="mb-4">
                <label class="form-label">6、您对加强和改进“一报告两评议”工作有何意见建议？</label>
                <textarea class="form-control" rows="3"
                    id="q6">{{ data.q6_suggestions_report if data else '' }}</textarea>
            </div>

        </div>
        <div class="card-footer text-end">
            <button class="btn btn-primary" onclick="submitData()">提交评议</button>
        </div>
    </div>
</div>
{% endblock %}

{% block script_extra %}
<script>
    async function submitData() {
        // 1. Get Values
        const q1 = document.querySelector('input[name="q1"]:checked')?.value;
        const q2 = document.querySelector('input[name="q2"]:checked')?.value;
        const q3 = document.querySelector('input[name="q3"]:checked')?.value;

        // 2. Validation (Q1-Q3 Required)
        if (!q1 || !q2 || !q3) {
            alert('请完成第1-3项必填评价！');
            return;
        }

        const q4Checks = document.querySelectorAll('.q4-check:checked');
        const q4Val = Array.from(q4Checks).map(c => c.value).join(',');

        const q5 = document.getElementById('q5').value;
        const q6 = document.getElementById('q6').value;

        if (!confirm('确认保存吗？')) return;

        try {
            const res = await fetch('/api/assessment/selection-appointment/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    q1_overall: q1,
                    q2_supervision: q2,
                    q3_rectification: q3,
                    q4_problems: q4Val,
                    q5_suggestions_employment: q5,
                    q6_suggestions_report: q6
                })
            });

            const data = await res.json();
            if (data.success) {
                alert('保存成功！');
                window.location.reload();
            } else {
                alert('提交失败：' + data.msg);
            }
        } catch (err) {
            alert('网络错误：' + err);
        }
    }
</script>
{% endblock %}