# 部门权重与测评账号映射实施方案 (最终版)

## 1. 核心需求
将抽象的 **打分角色**（如“职能部门正职 (含院长助理)”）映射到具体的 **部门+账号**。
由于部分角色涉及复杂的“或”逻辑（例如：既包含所有职能部门的正职，也包含院长助理部门的所有账号），单纯的“部门+类型”单一规则无法满足。

## 2. 解决方案：多重规则匹配列表

我们将 `RATER_RULES` 设计为 **`Role -> [Rule1, Rule2, ...]`** 的结构。
**逻辑**：只要账号满足列表中的**任意一条规则**，即视为拥有该角色权限。

### 规则对照表 (Visual Table)
此表为代码逻辑的直观展示。

| # | 权重表中的打分角色 (Rater Role) | 对应部门名称 (Dept Names) / 类型 | 账号类型 |
| :--- | :--- | :--- | :--- |
| 1 | **院领导** | 部门: `院领导` | L (院领导) |
| 2 | **职能部门正职 (含院长助理)** | **规则1**: 类型=`职能部门` <br> **规则2**: 部门=`院长助理` | P (正职) <br> **不限类型** |
| 3 | **职能部门副职** | 类型: `职能部门` | D (副职) |
| 4 | **本部门其他员工** | (动态逻辑: 打分人与被打分人 DeptID 相同) | E (其他) |
| 5 | **研究所正职** | 类型: `研究所` | P (正职) |
| 6 | **研究所副职** | 类型: `研究所` | D (副职) |
| 7 | **研究所其他员工** | 类型: `研究所` | E (其他) |
| 8 | **中心领导班子 (正职)** | 部门: `兰州化工研究中心`, `大庆化工研究中心` | P (正职) |
| 9 | **中心领导班子 (副职)** | 部门: `兰州化工研究中心`, `大庆化工研究中心` | D (副职) |
| 10 | **职工代表中基层领导人员 (两中心)** | 部门: `兰州化工研究中心`, `大庆化工研究中心` | C (中心基层) |
| 11 | **其他职工代表 (两中心)** | 部门: `兰州化工研究中心`, `大庆化工研究中心` | E (其他) |
| 12 | **昆冈班子正职** | 部门: `昆冈兰州分公司`, `昆冈抚顺分公司` | P (正职) |
| 13 | **昆冈班子副职** | 部门: `昆冈兰州分公司`, `昆冈抚顺分公司` | D (副职) |
| 14 | **职工代表中基层领导人员 (昆冈北京)** | 部门: `昆冈兰州分公司`, `昆冈抚顺分公司` | C (中心基层) |
| 15 | **其他职工代表 (昆冈北京)** | 部门: `昆冈兰州分公司`, `昆冈抚顺分公司` | E (其他) |
| 16 | **所属分公司班子正职** | 部门: **`昆冈兰州分公司`, `昆冈抚顺分公司`** | P (正职) |
| 17 | **所属分公司班子副职** | 部门: **`昆冈兰州分公司`, `昆冈抚顺分公司`** | D (副职) |
| 18 | **职工代表中基层领导人员 (分公司)** | 部门: **`昆冈兰州分公司`, `昆冈抚顺分公司`** | C (中心基层) |
| 19 | **其他职工代表 (分公司)** | 部门: **`昆冈兰州分公司`, `昆冈抚顺分公司`** | E (其他) |


### 规则表配置 (RATER_RULES)

```python
RATER_RULES = {
    # 1. 院领导
    '院领导': [
        {'dept_names': ['院领导'], 'types': ['L']}
    ],
    
    # 2. 职能部门正职 (含院长助理) - 【重点修正】
    # 规则A: 职能部门的正职
    # 规则B: 院长助理部门的所有账号 (不限类型，或按实际L类型)
    '职能部门正职 (含院长助理)': [
        {'dept_type': '职能部门', 'types': ['P']},
        {'dept_names': ['院长助理'], 'types': []} # Empty list = Allow all types
    ],
    
    # 3. 职能部门副职
    '职能部门副职': [
        {'dept_type': '职能部门', 'types': ['D']}
    ],
    
    # 4. 本部门其他员工 (动态判断，此处不配置静态规则)
    
    # 5-7. 研究所
    '研究所正职': [{'dept_type': '研究所', 'types': ['P']}],
    '研究所副职': [{'dept_type': '研究所', 'types': ['D']}],
    '研究所其他员工': [{'dept_type': '研究所', 'types': ['E']}],
    
    # 8-11. 两中心 (兰州、大庆)
    '中心领导班子 (正职)': [
        {'dept_names': ['兰州化工研究中心', '大庆化工研究中心'], 'types': ['P']}
    ],
    '中心领导班子 (副职)': [
        {'dept_names': ['兰州化工研究中心', '大庆化工研究中心'], 'types': ['D']}
    ],
    '职工代表中基层领导人员 (两中心)': [
        {'dept_names': ['兰州化工研究中心', '大庆化工研究中心'], 'types': ['C']}
    ],
    '其他职工代表 (两中心)': [
        {'dept_names': ['兰州化工研究中心', '大庆化工研究中心'], 'types': ['E']}
    ],

    # 12-15. 昆冈 (兰州、抚顺)
    '昆冈班子正职': [
        {'dept_names': ['昆冈兰州分公司', '昆冈抚顺分公司'], 'types': ['P']}
    ],
    '昆冈班子副职': [
        {'dept_names': ['昆冈兰州分公司', '昆冈抚顺分公司'], 'types': ['D']}
    ],
    '职工代表中基层领导人员 (昆冈北京)': [
        {'dept_names': ['昆冈兰州分公司', '昆冈抚顺分公司'], 'types': ['C']}
    ],
    '其他职工代表 (昆冈北京)': [
        {'dept_names': ['昆冈兰州分公司', '昆冈抚顺分公司'], 'types': ['E']}
    ],
    
    # 16-19. 分公司 (兰州、抚顺) - 指向相同部门
    '所属分公司班子正职': [
        {'dept_names': ['昆冈兰州分公司', '昆冈抚顺分公司'], 'types': ['P']}
    ],
    '所属分公司班子副职': [
        {'dept_names': ['昆冈兰州分公司', '昆冈抚顺分公司'], 'types': ['D']}
    ],
    '职工代表中基层领导人员 (分公司)': [
        {'dept_names': ['昆冈兰州分公司', '昆冈抚顺分公司'], 'types': ['C']}
    ],
    '其他职工代表 (分公司)': [
        {'dept_names': ['昆冈兰州分公司', '昆冈抚顺分公司'], 'types': ['E']}
    ],
}
```

## 3. 匹配函数实现

```python
def get_user_rater_roles(user_account, user_dept_info):
    """
    user_account: {account_type: 'P', ...}
    user_dept_info: {dept_name: '院长助理', dept_type: '职能部门'}
    """
    matched_roles = []
    
    for rater_role, rules_list in RATER_RULES.items():
        # 遍历该角色的所有规则，只要满足其中一条即可
        role_matched = False
        for rule in rules_list:
            # 1. Check Types (if verified list is not empty)
            if rule['types'] and user_account['account_type'] not in rule['types']:
                continue
                
            # 2. Check Dept (Name or Type)
            match_dept = False
            if 'dept_names' in rule:
                if user_dept_info['dept_name'] in rule['dept_names']:
                    match_dept = True
            elif 'dept_type' in rule:
                if user_dept_info.get('dept_type') == rule['dept_type']:
                    match_dept = True
                    
            if match_dept:
                role_matched = True
                break # 满足一条规则即可
        
        if role_matched:
            matched_roles.append(rater_role)
            
    return matched_roles
```

## 4. 验证案例 (院长助理)
1. **场景**：用户使用 `院长助理` 部门生成的 `L` 类账号登录。
2. **匹配过程**：
   - 检查角色 `职能部门正职 (含院长助理)`。
   - 规则 A (职能部门+P)：类型不匹配 (L != P)。Fail.
   - 规则 B (院长助理+不限)：部门名称匹配 `院长助理`，类型 `[]` 表示不限。Pass.
   - **结果**：该用户成功获得 `职能部门正职 (含院长助理)` 角色身份。

## 5. 被考核人 (Examinee) 与 中层管理人员映射表

根据您的要求，我整理了权重表中的 **列头（被考核人角色）** 与 **中层管理人员表 (`middle_managers`)** 中具体数据的对应关系。

**核心逻辑**：
人员的身份主要由 Excel 导入时的 **“员工角色”** 和 **“部门名称”** 共同决定。
（注：导入时系统限制员工角色必须在 `ALLOWED_ROLES` 列表中，我们将利用这一规范进行映射）

| # | 权重表中的被考核人角色 (Column Header) | 中层管理人员匹配条件 (Middle Manager Filter) | 推断的数据源 (Role + Dept) |
| :--- | :--- | :--- | :--- |
| 1 | **院长助理** | 角色 = `院长助理` | 明确对应 |
| 2 | **职能部门正职** | 角色 = `职能部门正职` | 明确对应 |
| 3 | **职能部门副职** | 角色 = `职能部门副职` | 明确对应 |
| 4 | **研究所正职** | 角色 = `研究所正职` | 明确对应 |
| 5 | **研究所副职** | 角色 = `研究所副职` | 明确对应 |
| 6 | **两中心正职** | 角色 = `中心正职` **AND** 部门 IN [`兰州化工研究中心`, `大庆化工研究中心`] | 部门需为两中心之一 |
| 7 | **两中心副职** | 角色 = `中心副职` **AND** 部门 IN [`兰州化工研究中心`, `大庆化工研究中心`] | |
| 8 | **昆冈班子副职 (北京)** | 角色 = `中心副职` **AND** 部门 = `昆冈公司` (北京) | 角色复用“中心副职”，以部门区分 |
| 9 | **所属分公司 (兰州、抚顺) 班子正职** | 角色 = `中心正职` **AND** 部门 IN [`昆冈兰州分公司`, `昆冈抚顺分公司`] | 角色复用“中心正职”，以部门区分 |
| 10 | **所属分公司 (兰州、抚顺) 班子副职** | 角色 = `中心副职` **AND** 部门 IN [`昆冈兰州分公司`, `昆冈抚顺分公司`] | 角色复用“中心副职”，以部门区分 |

### 代码实现预览: 被考核人身份识别 (Examinee Logic)

```python
def get_examinee_role_key(person_role, dept_name):
    """
    输入：中层人员的'员工角色'(person_role) 和 '部门名称'(dept_name)
    输出：对应的权重表列头 (column header)
    """
    
    # 1. 直接匹配基础角色
    if person_role in ['院长助理', '职能部门正职', '职能部门副职', '研究所正职', '研究所副职']:
        return person_role
        
    # 2. 复合角色：中心/昆冈/分公司 (基于部门区分)
    if person_role == '中心正职':
        if dept_name in ['兰州化工研究中心', '大庆化工研究中心']:
            return '两中心正职'
        if dept_name in ['昆冈兰州分公司', '昆冈抚顺分公司']:
            return '所属分公司 (兰州、抚顺) 班子正职'
            
    if person_role == '中心副职':
        if dept_name in ['兰州化工研究中心', '大庆化工研究中心']:
            return '两中心副职'
        if dept_name == '昆冈公司': # 北京
            return '昆冈班子副职 (北京)'
        if dept_name in ['昆冈兰州分公司', '昆冈抚顺分公司']:
            return '所属分公司 (兰州、抚顺) 班子副职'
            
    return None # 未知角色
```

**注意事项**：
1.  **`ALLOWED_ROLES`**：为了支持这些映射，我们将确保中层人员导入时填写的“员工角色”为基础值（如：`中心正职`, `中心副职`），而不用填写冗长的权重表头名称。系统会根据部门名称自动归类到正确的列。
2.  **昆冈班子正职**：权重表中无此列（仅有副职），因此无需映射。

## 6. 特殊权重共享逻辑 (Special Shared Weight Logic)

根据您的需求，在**权重配置页面**和**校验逻辑**中，需增加以下特殊处理：

**场景**：
当被考核人 (Column) 为 **`职能部门正职 (含院长助理)`** 时：

| 关联打分人 (Rows) | 逻辑要求 |
| :--- | :--- |
| **`中心领导班子 (正职)`** | 这两行的权重**必须相同**，且在总分校验时**只算一次**。 |
| **`所属分公司 (兰州、抚顺) 班子正职`** | (即：两者共享同一个 10% 的配额) |

**实施方案**：

1.  **Frontend (前端交互)**：
    *   在 `weight_config_dept.html` 中，通过 JS 将这两该单元格进行绑定。
    *   用户修改其中一个，另一个自动同步。
    *   显示提示信息：“这两项共享权重”。

2.  **Validation (校验逻辑)**：
    *   前端/后端计算总分（Total）时：
        `Total = Sum(其他项) + (中心正职权重 OR 分公司正职权重)`
        *而不是两者相加*。
    *   后端保存时，依然会为这两行分别写入数据库（存储相同的值），方便读取时直接查询，不需要运行时二次转换。

3.  **计算逻辑 (Scoring)**：
    *   当“中心正职”打分时，取权重表中的 10%。
    *   当“分公司正职”打分时，取权重表中的 10%。

## 7. 数据联动与自动更新机制 (Dynamic Updates)

您关心的“表更新后映射关系是否自动更新”的问题，答案是：**是的，完全自动更新。**

这是因为我们采用的是 **动态运行时解析 (Runtime Resolution)** 策略，而不是将“谁对应谁”写死在数据库里。

### 工作机制：
1.  **当您重新导入《部门配置表》时**：
    *   只要新表的部门类型（如“职能部门”）或名称关键词（如“院长助理”）保持不变，系统会自动识别新部门下的新账号，赋予其对应的投票权。
    *   *例如：您新增了一个“审计部”并标记为“职能部门”，该部门生成的正职账号会自动拥有“职能部门正职”的打分权，无需额外配置。*

2.  **当您重新导入《中层管理人员表》时**：
    *   系统每次加载人员列表或计算分数时，都会实时读取人员当前的“角色”和“部门”。
    *   *例如：张三从“职能部门”调岗到了“研究所”，您只需更新人员表，下次算分时，只属于“研究所”的权重规则会自动应用到他身上。*

### 唯一约束：
*   对于规则表中**写死名称**的部门（如 `昆冈兰州分公司`），请在 Excel 导入时保持名称一致。如果 Excel 中改名为 “兰州分公司”，则需要同步修改代码中的配置字典。

